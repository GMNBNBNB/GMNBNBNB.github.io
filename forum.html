<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anonymous Calming Forum - Mood Station</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Global styles */
    * {
      box-sizing: border-box;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Theme color variables */
    :root {
      --primary-color: #5AC7A7;
      --secondary-color: #346187;
      --bg-gradient-start: #D9EFFF;
      --bg-gradient-end: #E5FFE5;
      --text-color: #335;
      --light-bg: rgba(255,255,255,0.85);
      --shadow-color: rgba(80,140,200,0.12);
      --border-color: #aad1f5;
      --success-color: #75cc93;
      --warning-color: #ff9966;
      --error-color: #ff6b6b;
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-gradient-start: #1a2f4b;
        --bg-gradient-end: #2d4a5d;
        --text-color: #e0e0e0;
        --light-bg: rgba(30,30,30,0.85);
        --shadow-color: rgba(0,0,0,0.3);
        --border-color: #4a7c9e;
      }
    }

    body {
      margin: 0; 
      padding: 0;
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      position: relative;
      overflow-x: hidden;
    }

    /* Background decoration */
    .bg-decoration {
      position: fixed;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: float 20s infinite ease-in-out;
    }

    .bg-decoration:nth-child(1) {
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .bg-decoration:nth-child(2) {
      top: 70%;
      right: 10%;
      animation-delay: 5s;
      width: 150px;
      height: 150px;
    }

    .bg-decoration:nth-child(3) {
      bottom: 10%;
      left: 50%;
      animation-delay: 10s;
      width: 80px;
      height: 80px;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -30px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
    }

    /* Help button */
    .help-button {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: var(--primary-color);
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.3);
      transition: all 0.3s;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .help-button:hover {
      background: #4db897;
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(90, 199, 167, 0.4);
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s;
    }

    .modal-overlay.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Modal content */
    .modal-content {
      background: var(--light-bg);
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: slideDown 0.3s;
      margin: 20px;
    }

    @keyframes slideDown {
      from { 
        opacity: 0;
        transform: translateY(-50px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 16px;
    }

    .modal-title {
      font-size: 1.8em;
      color: var(--secondary-color);
      margin: 0;
    }

    .close-button {
      background: none;
      border: none;
      font-size: 28px;
      color: #888;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .close-button:hover {
      background: #f0f0f0;
      color: #333;
    }

    .modal-section {
      margin-bottom: 24px;
    }

    .modal-section h3 {
      color: var(--primary-color);
      font-size: 1.3em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-section p {
      line-height: 1.7;
      color: var(--text-color);
      margin-bottom: 12px;
    }

    .modal-section ul {
      line-height: 1.8;
      color: var(--text-color);
      padding-left: 24px;
    }

    .modal-section li {
      margin-bottom: 8px;
    }

    .icon {
      font-size: 1.2em;
    }

    .highlight {
      background: linear-gradient(120deg, transparent 0%, var(--primary-color) 0%, var(--primary-color) 100%, transparent 100%);
      background-size: 100% 30%;
      background-position: 0 85%;
      background-repeat: no-repeat;
      padding: 2px 4px;
      font-weight: 500;
    }

    .warning-box {
      background: #fff3cd;
      border-left: 4px solid var(--warning-color);
      padding: 12px 16px;
      border-radius: 8px;
      margin: 12px 0;
    }

    .info-box {
      background: #d1ecf1;
      border-left: 4px solid var(--primary-color);
      padding: 12px 16px;
      border-radius: 8px;
      margin: 12px 0;
    }

    .container {
      max-width: 600px;
      margin: 40px auto 24px auto;
      background: var(--light-bg);
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-color);
      padding: 36px 24px 28px 24px;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    h1 {
      text-align: center;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--secondary-color);
      letter-spacing: 1px;
      font-size: 1.8em;
    }

    /* Form section */
    .form-section {
      margin-bottom: 24px;
      text-align: center;
    }

    /* Character counter */
    .char-counter {
      text-align: right;
      font-size: 0.85em;
      color: #88a;
      margin-bottom: 8px;
      transition: color 0.3s;
    }

    .char-counter.warning {
      color: var(--warning-color);
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border: 2px solid transparent;
      border-radius: 12px;
      background: #F1F8FC;
      font-size: 1.05em;
      padding: 12px;
      resize: vertical;
      transition: all 0.3s;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.2);
    }

    /* Button styles */
    button {
      padding: 10px 24px;
      background: var(--primary-color);
      border-radius: 10px;
      border: none;
      color: white;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      background: #4db897;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Button ripple effect */
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::after {
      width: 300px;
      height: 300px;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Emoji picker */
    .emoji-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      background: none;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }

    /* Hint text */
    .emoji-hint {
      color: #6BB5A9;
      font-size: 0.88em;
      text-align: center;
      margin-bottom: 8px;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success-color);
    }

    .notification.error {
      background: var(--error-color);
    }

    .notification.warning {
      background: var(--warning-color);
    }

    /* Message feed */
    .feed {
      margin-top: 32px;
      min-height: 100px;
    }

    /* Filter and sort controls */
    .feed-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .filter-btn:hover {
      background: #e0e0e0;
    }

    .filter-btn.active:hover {
      background: #4db897;
    }

    /* Message card */
    .message {
      background: #fafbfc;
      border-radius: 12px;
      margin-bottom: 16px;
      padding: 16px 20px;
      box-shadow: 0 3px 12px var(--shadow-color);
      animation: slideIn 0.5s ease-out;
      position: relative;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s;
    }

    .message:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-color);
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateX(-20px);
      }
      to { 
        opacity: 1; 
        transform: translateX(0);
      }
    }

    /* Message content */
    .message-content {
      font-size: 1.05em;
      line-height: 1.6;
      word-wrap: break-word;
      margin-bottom: 12px;
    }

    /* Message footer */
    .message-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .timestamp {
      font-size: 0.85em;
      color: #88a;
    }

    /* Action buttons */
    .message-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      color: #88a;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .action-btn:hover {
      background: #f0f0f0;
      color: var(--primary-color);
    }

    .action-btn.liked {
      color: #ff6b6b;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #88a;
    }

    .empty-state-icon {
      font-size: 3em;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Load more button */
    .load-more {
      text-align: center;
      margin-top: 24px;
    }

    .load-more-btn {
      background: none;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 8px 24px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .load-more-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Responsive design */
    @media (max-width: 600px) {
      .container { 
        margin: 20px 10px;
        padding: 24px 16px;
      }
      
      h1 { 
        font-size: 1.5em;
      }
      
      textarea { 
        font-size: 1em; 
      }
      
      .notification {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
      }
      
      .notification.show {
        transform: translateY(0);
      }
      
      .feed-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-buttons {
        justify-content: center;
      }

      .help-button {
        width: 44px;
        height: 44px;
        font-size: 20px;
        top: 10px;
        left: 10px;
      }

      .modal-content {
        padding: 24px 20px;
        margin: 10px;
        max-height: 90vh;
      }

      .modal-title {
        font-size: 1.4em;
      }
    }

    /* Accessibility */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus styles */
    *:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Background decorations -->
  <div class="bg-decoration"></div>
  <div class="bg-decoration"></div>
  <div class="bg-decoration"></div>

  <!-- Help Button -->
  <button class="help-button" onclick="openHelpModal()" aria-label="Open user manual">
    ?
  </button>

  <!-- Help Modal -->
  <div class="modal-overlay" id="helpModal" onclick="closeHelpModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">📖 User Manual</h2>
        <button class="close-button" onclick="closeHelpModal()" aria-label="Close modal">&times;</button>
      </div>

      <div class="modal-section">
        <h3><span class="icon">🌟</span> Welcome to Mood Station</h3>
        <p>
          This is an <span class="highlight">anonymous and safe space</span> where you can freely express your feelings, thoughts, and emotions. 
          Share your mood with the community and receive support from others who understand.
        </p>
        <div class="info-box">
          <strong>💡 What is this?</strong><br>
          An anonymous forum designed to help you express emotions, connect with others experiencing similar feelings, and find calm in a supportive environment.
        </div>
      </div>

      <div class="modal-section">
        <h3><span class="icon">📝</span> How to Use</h3>
        <ul>
          <li><strong>Write Your Message:</strong> Type your feelings or thoughts in the text box (max 280 characters)</li>
          <li><strong>Add Emojis:</strong> Click emoji buttons to express your mood visually, or type emoji codes like :) or &lt;3</li>
          <li><strong>Share Anonymously:</strong> Click "Share Mood" to post - no personal information required</li>
          <li><strong>Interact:</strong> Like messages that resonate with you by clicking the ❤️ button</li>
          <li><strong>Filter & Sort:</strong> Browse messages by time period (All/Today/This Week) or sort by newest/oldest/most popular</li>
          <li><strong>Keyboard Shortcut:</strong> Press <code>Ctrl + Enter</code> to submit your message quickly</li>
        </ul>
      </div>

      <div class="modal-section">
        <h3><span class="icon">✨</span> Features</h3>
        <ul>
          <li><strong>Complete Anonymity:</strong> No registration, no tracking, no personal data collection</li>
          <li><strong>Local Storage:</strong> All messages are stored in your browser only</li>
          <li><strong>Content Moderation:</strong> Automatic filtering of harmful or abusive language</li>
          <li><strong>Mood Detection:</strong> Messages are automatically categorized by emotion</li>
          <li><strong>Dark Mode Support:</strong> Automatically adapts to your system preferences</li>
        </ul>
      </div>

      <div class="modal-section">
        <h3><span class="icon">🚫</span> Prohibited Behaviors</h3>
        <div class="warning-box">
          <strong>⚠️ The following actions are NOT allowed:</strong>
        </div>
        <ul>
          <li><strong>Hate Speech:</strong> No offensive, discriminatory, or hateful language</li>
          <li><strong>Abusive Content:</strong> No profanity, insults, or harassment</li>
          <li><strong>Threats:</strong> No violent or threatening language toward anyone</li>
          <li><strong>Spam:</strong> No excessive repeated characters or all-caps messages</li>
          <li><strong>Personal Information:</strong> Do not share yours or others' private information</li>
          <li><strong>Harmful Content:</strong> No promotion of self-harm, violence, or illegal activities</li>
        </ul>
        <p style="margin-top: 12px;">
          <em>Messages violating these rules will be automatically rejected by our content moderation system.</em>
        </p>
      </div>

      <div class="modal-section">
        <h3><span class="icon">🛡️</span> Community Guidelines</h3>
        <ul>
          <li>Be kind and supportive to others</li>
          <li>Respect different perspectives and experiences</li>
          <li>Use constructive language instead of criticism</li>
          <li>Remember that everyone is going through their own journey</li>
          <li>If you see something concerning, simply don't engage with it</li>
        </ul>
      </div>

      <div class="modal-section">
        <h3><span class="icon">🔒</span> Privacy & Data</h3>
        <p>
          Your privacy is our priority. This forum:
        </p>
        <ul>
          <li>Does not collect or store any personal information</li>
          <li>Stores all messages locally in your browser (localStorage)</li>
          <li>Does not use cookies or tracking technologies</li>
          <li>Does not send data to any external servers</li>
          <li>Data is only accessible from your current device</li>
        </ul>
        <div class="info-box">
          <strong>💾 Note:</strong> Clearing your browser data will delete all messages. There is no way to recover them.
        </div>
      </div>
    </div>
  </div>

  <div class="container" role="main" aria-label="Anonymous mood wall">
    <h1>Mood Station</h1>
    
    <div class="form-section">
      <form id="msgForm" autocomplete="off">
        <div class="emoji-hint">Share your feelings, let warmth spread ✨</div>
        
        <div class="toolbar">
          <div class="emoji-picker" role="toolbar" aria-label="Emoji selection">
            <button type="button" class="emoji-btn" onclick="insertEmoji('😊')" aria-label="Happy">😊</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😔')" aria-label="Sad">😔</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('❤️')" aria-label="Love">❤️</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🌱')" aria-label="Growth">🌱</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🌈')" aria-label=" Rainbow">🌈</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('💪')" aria-label="Strong">💪</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🤗')" aria-label="Hug">🤗</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('✨')" aria-label="Sparkle">✨</button>
          </div>
        </div>
        
        <div class="char-counter" id="charCounter" aria-live="polite">
          <span id="charCount">0</span> / 280
        </div>
        
        <textarea 
          id="message" 
          placeholder="Write down your feelings or thoughts, this is your safe space..." 
          maxlength="280" 
          aria-label="Message content"
          aria-describedby="charCounter"
          required
        ></textarea>
        
        <button type="submit" id="submitBtn">
          <span id="submitText">Share Mood</span>
        </button>
      </form>
    </div>

    <div class="feed-controls">
      <div class="filter-buttons" role="group" aria-label="Filter options">
        <button class="filter-btn active" onclick="setFilter('all')" aria-pressed="true">All</button>
        <button class="filter-btn" onclick="setFilter('today')" aria-pressed="false">Today</button>
        <button class="filter-btn" onclick="setFilter('week')" aria-pressed="false">This Week</button>
      </div>
      <select id="sortSelect" aria-label="Sort method" onchange="sortMessages()">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="popular">Most Popular</option>
      </select>
    </div>

    <div class="feed" id="feed" role="feed" aria-live="polite" aria-label="Message list">
      <div class="empty-state">
        <div class="empty-state-icon">💭</div>
        <p>No messages yet, be the first to share!</p>
      </div>
    </div>
    
    <div class="load-more" id="loadMore" style="display: none;">
      <button class="load-more-btn" onclick="loadMoreMessages()">Load More</button>
    </div>
  </div>

  <!-- Notification container -->
  <div id="notification" class="notification" role="alert" aria-live="assertive"></div>
  
<script>
  // Configuration
  const CONFIG = {
    MAX_MESSAGE_LENGTH: 280,
    MESSAGES_PER_PAGE: 10,
    STORAGE_KEY: 'forum_messages_v2',
    LIKES_KEY: 'forum_likes',
    REPORT_KEY: 'forum_reports'
  };

  // Modal functions
  function openHelpModal() {
    document.getElementById('helpModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeHelpModal(event) {
    if (!event || event.target === event.currentTarget) {
      document.getElementById('helpModal').classList.remove('show');
      document.body.style.overflow = 'auto';
    }
  }

  // Close modal with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeHelpModal();
    }
  });

  // Abusive words list (expanded)
  const abusiveWords = [
    // English
    "fuck", "shit", "bitch", "asshole", "damn", "hell", "crap", "piss",
    "dick", "cock", "pussy", "bastard", "slut", "whore", "fag", "nigger",
    "retard", "cunt", "motherfucker", "hate", "kill", "die", "rape",
    // Common variations
    "fck", "sht", "btch", "a$$", "d4mn", "h3ll", "cr4p"
  ];

  // Sensitive word hints
  const sensitiveHints = {
    "die": "Life is precious, let's use more positive words",
    "hate": "Try using 'dislike' or 'disagree' instead",
    "kill": "Let's express ourselves more peacefully",
    "stupid": "Everyone is learning, try 'needs improvement'",
    "idiot": "Be kind, we all make mistakes"
  };

  // State management
  let state = {
    messages: [],
    filter: 'all',
    sort: 'newest',
    currentPage: 0,
    isLoading: false
  };

  // Initialize
  function init() {
    loadMessages();
    setupEventListeners();
    renderFeed();
    updateCharCounter();
  }

  // Setup event listeners
  function setupEventListeners() {
    const textarea = document.getElementById('message');
    textarea.addEventListener('input', updateCharCounter);
    textarea.addEventListener('keydown', handleKeyPress);
    
    document.getElementById('msgForm').addEventListener('submit', handleSubmit);
  }

  // Handle keyboard events
  function handleKeyPress(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      document.getElementById('msgForm').dispatchEvent(new Event('submit'));
    }
  }

  // Load messages
  function loadMessages() {
    try {
      const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
      state.messages = stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error('Failed to load messages:', e);
      state.messages = [];
    }
  }

  // Save messages
  function saveMessages() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.messages));
    } catch (e) {
      console.error('Failed to save messages:', e);
      showNotification('Storage full, some messages may not be saved', 'warning');
    }
  }

  // Get user likes
  function getLikes() {
    try {
      return JSON.parse(localStorage.getItem(CONFIG.LIKES_KEY) || '{}');
    } catch {
      return {};
    }
  }

  // Save likes
  function saveLikes(likes) {
    localStorage.setItem(CONFIG.LIKES_KEY, JSON.stringify(likes));
  }

  // Insert emoji
  function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    textarea.focus();
    
    updateCharCounter();
  }

  // Update character counter
  function updateCharCounter() {
    const textarea = document.getElementById('message');
    const counter = document.getElementById('charCounter');
    const count = document.getElementById('charCount');
    const length = textarea.value.length;
    
    count.textContent = length;
    
    if (length > 250) {
      counter.classList.add('warning');
    } else {
      counter.classList.remove('warning');
    }
  }

  // Content moderation
  function moderateContent(text) {
    const lowerText = text.toLowerCase();
    
    // Check for abusive words
    for (const word of abusiveWords) {
      if (lowerText.includes(word.toLowerCase())) {
        // Find sensitive word hints
        for (const [key, hint] of Object.entries(sensitiveHints)) {
          if (word.includes(key) || key.includes(word)) {
            return { 
              passed: false, 
              message: `Detected unfriendly language "${word}", ${hint}` 
            };
          }
        }
        return { 
          passed: false, 
          message: `Content contains unfriendly words "${word}", please revise` 
        };
      }
    }
    
    // Check for repeated characters
    if (/(.)\1{5,}/.test(text)) {
      return { 
        passed: false, 
        message: 'Please avoid excessive repeated characters' 
      };
    }
    
    // Check for all caps (shouting)
    if (text.length > 10 && text === text.toUpperCase() && /[A-Z]/.test(text)) {
      return { 
        passed: false, 
        message: 'Please avoid all caps, it seems like shouting' 
      };
    }
    
    return { passed: true };
  }

  // Handle form submission
  async function handleSubmit(e) {
    e.preventDefault();
    
    if (state.isLoading) return;
    
    const textarea = document.getElementById('message');
    const text = textarea.value.trim();
    
    if (!text) {
      showNotification('Please write something before sharing', 'warning');
      return;
    }
    
    // Content moderation
    const moderation = moderateContent(text);
    if (!moderation.passed) {
      showNotification(moderation.message, 'error');
      return;
    }
    
    // Prevent duplicate submission
    state.isLoading = true;
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    submitBtn.disabled = true;
    submitText.innerHTML = '<span class="loading"></span>';
    
    // Simulate submission delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Create new message
    const newMessage = {
      id: Date.now() + Math.random(),
      text: processText(text),
      time: Date.now(),
      likes: 0,
      mood: detectMood(text)
    };
    
    // Add to message list
    state.messages.unshift(newMessage);
    saveMessages();
    
    // Clear input
    textarea.value = '';
    updateCharCounter();
    
    // Restore button
    submitBtn.disabled = false;
    submitText.textContent = 'Share Mood';
    state.isLoading = false;
    
    // Show success notification
    showNotification('Your mood has been shared, thank you 🌈', 'success');
    
    // Re-render
    renderFeed();
    
    // Scroll to top to see new message
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Process text (auto-convert emojis)
  function processText(text) {
    // Auto-convert emoji codes
    const emojiMap = {
      ':)': '😊',
      ':-)': '😊',
      ':(': '😔',
      ':-(': '😔',
      ':D': '😄',
      ':-D': '😄',
      ':P': '😛',
      ':-P': '😛',
      ':o': '😮',
      ':-o': '😮',
      ':|': '😐',
      ':-|': '😐',
      ';)': '😉',
      ';-)': '😉',
      '<3': '❤️',
      '</3': '💔',
      ':*': '😘',
      ':heart:': '❤️',
      ':smile:': '😊',
      ':sad:': '😢',
      ':happy:': '😄',
      ':angry:': '😠',
      ':love:': '❤️',
      ':star:': '⭐',
      ':fire:': '🔥',
      ':thumbsup:': '👍',
      ':thumbsdown:': '👎',
      ':clap:': '👏',
      ':pray:': '🙏'
    };
    
    let processed = text;
    for (const [code, emoji] of Object.entries(emojiMap)) {
      processed = processed.replace(new RegExp(escapeRegExp(code), 'g'), emoji);
    }
    
    return processed;
  }

  // Escape regex special characters
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Detect mood
  function detectMood(text) {
    const moods = {
      happy: ['happy', 'joy', 'glad', 'excited', 'great', 'awesome', 'wonderful', '😊', '😄', '🎉'],
      sad: ['sad', 'unhappy', 'down', 'depressed', 'lonely', 'cry', '😢', '😔', '💔'],
      angry: ['angry', 'mad', 'furious', 'annoyed', 'frustrated', '😠', '😡'],
      love: ['love', 'like', 'adore', 'heart', '❤️', '💕', '😍'],
      neutral: []
    };
    
    const lowerText = text.toLowerCase();
    for (const [mood, keywords] of Object.entries(moods)) {
      if (keywords.some(keyword => lowerText.includes(keyword) || text.includes(keyword))) {
        return mood;
      }
    }
    
    return 'neutral';
  }

  // Show notification
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    
    // Show notification
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // Auto hide
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  // Format time
  function formatTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    // Just now (within 1 minute)
    if (diff < 60000) {
      return 'just now';
    }
    
    // Minutes ago
    if (diff < 3600000) {
      const minutes = Math.floor(diff / 60000);
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    }
    
    // Hours ago
    if (diff < 86400000) {
      const hours = Math.floor(diff / 3600000);
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    }
    
    // Days ago
    if (diff < 604800000) {
      const days = Math.floor(diff / 86400000);
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    
    // Specific date
    const date = new Date(timestamp);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Set filter
  function setFilter(filter) {
    state.filter = filter;
    state.currentPage = 0;
    
    // Update button states
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed', 'false');
    });
    event.target.classList.add('active');
    event.target.setAttribute('aria-pressed', 'true');
    
    renderFeed();
  }

  // Sort messages
  function sortMessages() {
    const sortSelect = document.getElementById('sortSelect');
    state.sort = sortSelect.value;
    state.currentPage = 0;
    renderFeed();
  }

  // Filter messages
  function filterMessages(messages) {
    const now = Date.now();
    const DAY = 86400000;
    
    switch (state.filter) {
      case 'today':
        return messages.filter(msg => now - msg.time < DAY);
      case 'week':
        return messages.filter(msg => now - msg.time < DAY * 7);
      default:
        return messages;
    }
  }

  // Sort messages list
  function sortMessagesList(messages) {
    const sorted = [...messages];
    
    switch (state.sort) {
      case 'oldest':
        return sorted.sort((a, b) => a.time - b.time);
      case 'popular':
        return sorted.sort((a, b) => b.likes - a.likes);
      default: // newest
        return sorted.sort((a, b) => b.time - a.time);
    }
  }

  // Toggle like
  function toggleLike(messageId) {
    const likes = getLikes();
    const message = state.messages.find(m => m.id === messageId);
    
    if (!message) return;
    
    if (likes[messageId]) {
      // Unlike
      delete likes[messageId];
      message.likes = Math.max(0, message.likes - 1);
    } else {
      // Like
      likes[messageId] = true;
      message.likes = (message.likes || 0) + 1;
    }
    
    saveLikes(likes);
    saveMessages();
    renderFeed();
  }

  // Render feed
  function renderFeed() {
    const feed = document.getElementById('feed');
    const filtered = filterMessages(state.messages);
    const sorted = sortMessagesList(filtered);
    
    const displayCount = (state.currentPage + 1) * CONFIG.MESSAGES_PER_PAGE;
    const displayMessages = sorted.slice(0, displayCount);
    
    if (displayMessages.length === 0) {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">💭</div>
          <p>No messages yet, be the first to share!</p>
        </div>
      `;
      document.getElementById('loadMore').style.display = 'none';
      return;
    }
    
    const likes = getLikes();
    
    feed.innerHTML = displayMessages.map(msg => `
      <div class="message">
        <div class="message-content">${escapeHtml(msg.text)}</div>
        <div class="message-footer">
          <span class="timestamp">${formatTime(msg.time)}</span>
          <div class="message-actions">
            <button class="action-btn ${likes[msg.id] ? 'liked' : ''}" onclick="toggleLike(${msg.id})" aria-label="Like message">
              ❤️ <span>${msg.likes || 0}</span>
            </button>
          </div>
        </div>
      </div>
    `).join('');
    
    // Show/hide load more button
    const loadMore = document.getElementById('loadMore');
    loadMore.style.display = sorted.length > displayMessages.length ? 'block' : 'none';
  }

  // Load more messages
  function loadMoreMessages() {
    state.currentPage++;
    renderFeed();
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initialize on page load
  window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
