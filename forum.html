<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anonymous Calming Forum - Mood Station</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Global styles */
    * {
      box-sizing: border-box;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Theme color variables */
    :root {
      --primary-color: #5AC7A7;
      --secondary-color: #346187;
      --bg-gradient-start: #D9EFFF;
      --bg-gradient-end: #E5FFE5;
      --text-color: #335;
      --light-bg: rgba(255,255,255,0.85);
      --shadow-color: rgba(80,140,200,0.12);
      --border-color: #aad1f5;
      --success-color: #75cc93;
      --warning-color: #ff9966;
      --error-color: #ff6b6b;
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-gradient-start: #1a2f4b;
        --bg-gradient-end: #2d4a5d;
        --text-color: #e0e0e0;
        --light-bg: rgba(30,30,30,0.85);
        --shadow-color: rgba(0,0,0,0.3);
        --border-color: #4a7c9e;
      }
    }

    body {
      margin: 0; 
      padding: 0;
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      position: relative;
      overflow-x: hidden;
    }

    /* Background decoration */
    .bg-decoration {
      position: fixed;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: float 20s infinite ease-in-out;
    }

    .bg-decoration:nth-child(1) {
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .bg-decoration:nth-child(2) {
      top: 70%;
      right: 10%;
      animation-delay: 5s;
      width: 150px;
      height: 150px;
    }

    .bg-decoration:nth-child(3) {
      bottom: 10%;
      left: 50%;
      animation-delay: 10s;
      width: 80px;
      height: 80px;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -30px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
    }

    .container {
      max-width: 600px;
      margin: 40px auto 24px auto;
      background: var(--light-bg);
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-color);
      padding: 36px 24px 28px 24px;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    h1 {
      text-align: center;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--secondary-color);
      letter-spacing: 1px;
      font-size: 1.8em;
    }

    /* Form section */
    .form-section {
      margin-bottom: 24px;
      text-align: center;
    }

    /* Character counter */
    .char-counter {
      text-align: right;
      font-size: 0.85em;
      color: #88a;
      margin-bottom: 8px;
      transition: color 0.3s;
    }

    .char-counter.warning {
      color: var(--warning-color);
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border: 2px solid transparent;
      border-radius: 12px;
      background: #F1F8FC;
      font-size: 1.05em;
      padding: 12px;
      resize: vertical;
      transition: all 0.3s;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.2);
    }

    /* Button styles */
    button {
      padding: 10px 24px;
      background: var(--primary-color);
      border-radius: 10px;
      border: none;
      color: white;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      background: #4db897;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Button ripple effect */
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::after {
      width: 300px;
      height: 300px;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Emoji picker */
    .emoji-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      background: none;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }

    /* Hint text */
    .emoji-hint {
      color: #6BB5A9;
      font-size: 0.88em;
      text-align: center;
      margin-bottom: 8px;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success-color);
    }

    .notification.error {
      background: var(--error-color);
    }

    .notification.warning {
      background: var(--warning-color);
    }

    /* Message feed */
    .feed {
      margin-top: 32px;
      min-height: 100px;
    }

    /* Filter and sort controls */
    .feed-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .filter-btn:hover {
      background: #e0e0e0;
    }

    .filter-btn.active:hover {
      background: #4db897;
    }

    /* Message card */
    .message {
      background: #fafbfc;
      border-radius: 12px;
      margin-bottom: 16px;
      padding: 16px 20px;
      box-shadow: 0 3px 12px var(--shadow-color);
      animation: slideIn 0.5s ease-out;
      position: relative;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s;
    }

    .message:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-color);
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateX(-20px);
      }
      to { 
        opacity: 1; 
        transform: translateX(0);
      }
    }

    /* Message content */
    .message-content {
      font-size: 1.05em;
      line-height: 1.6;
      word-wrap: break-word;
      margin-bottom: 12px;
    }

    /* Message footer */
    .message-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .timestamp {
      font-size: 0.85em;
      color: #88a;
    }

    /* Action buttons */
    .message-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      color: #88a;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .action-btn:hover {
      background: #f0f0f0;
      color: var(--primary-color);
    }

    .action-btn.liked {
      color: #ff6b6b;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #88a;
    }

    .empty-state-icon {
      font-size: 3em;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Load more button */
    .load-more {
      text-align: center;
      margin-top: 24px;
    }

    .load-more-btn {
      background: none;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 8px 24px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .load-more-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    /* Responsive design */
    @media (max-width: 600px) {
      .container { 
        margin: 20px 10px;
        padding: 24px 16px;
      }
      
      h1 { 
        font-size: 1.5em;
      }
      
      textarea { 
        font-size: 1em; 
      }
      
      .notification {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
      }
      
      .notification.show {
        transform: translateY(0);
      }
      
      .feed-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-buttons {
        justify-content: center;
      }
    }

    /* Accessibility */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus styles */
    *:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Background decorations -->
  <div class="bg-decoration"></div>
  <div class="bg-decoration"></div>
  <div class="bg-decoration"></div>

  <div class="container" role="main" aria-label="Anonymous mood wall">
    <h1>Mood Station</h1>
    
    <div class="form-section">
      <form id="msgForm" autocomplete="off">
        <div class="emoji-hint">Share your feelings, let warmth spread ✨</div>
        
        <div class="toolbar">
          <div class="emoji-picker" role="toolbar" aria-label="Emoji selection">
            <button type="button" class="emoji-btn" onclick="insertEmoji('😊')" aria-label="Happy">😊</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('😔')" aria-label="Sad">😔</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('❤️')" aria-label="Love">❤️</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🌱')" aria-label="Growth">🌱</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🌈')" aria-label=" Rainbow">🌈</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('💪')" aria-label="Strong">💪</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('🤗')" aria-label="Hug">🤗</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('✨')" aria-label="Sparkle">✨</button>
          </div>
        </div>
        
        <div class="char-counter" id="charCounter" aria-live="polite">
          <span id="charCount">0</span> / 280
        </div>
        
        <textarea 
          id="message" 
          placeholder="Write down your feelings or thoughts, this is your safe space..." 
          maxlength="280" 
          aria-label="Message content"
          aria-describedby="charCounter"
          required
        ></textarea>
        
        <button type="submit" id="submitBtn">
          <span id="submitText">Share Mood</span>
        </button>
      </form>
    </div>

    <div class="feed-controls">
      <div class="filter-buttons" role="group" aria-label="Filter options">
        <button class="filter-btn active" onclick="setFilter('all')" aria-pressed="true">All</button>
        <button class="filter-btn" onclick="setFilter('today')" aria-pressed="false">Today</button>
        <button class="filter-btn" onclick="setFilter('week')" aria-pressed="false">This Week</button>
      </div>
      <select id="sortSelect" aria-label="Sort method" onchange="sortMessages()">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="popular">Most Popular</option>
      </select>
    </div>

    <div class="feed" id="feed" role="feed" aria-live="polite" aria-label="Message list">
      <div class="empty-state">
        <div class="empty-state-icon">💭</div>
        <p>No messages yet, be the first to share!</p>
      </div>
    </div>
    
    <div class="load-more" id="loadMore" style="display: none;">
      <button class="load-more-btn" onclick="loadMoreMessages()">Load More</button>
    </div>
  </div>

  <!-- Notification container -->
  <div id="notification" class="notification" role="alert" aria-live="assertive"></div>
  
<script>
  // Configuration
  const CONFIG = {
    MAX_MESSAGE_LENGTH: 280,
    MESSAGES_PER_PAGE: 10,
    STORAGE_KEY: 'forum_messages_v2',
    LIKES_KEY: 'forum_likes',
    REPORT_KEY: 'forum_reports'
  };

  // Abusive words list (expanded)
  const abusiveWords = [
    // English
    "fuck", "shit", "bitch", "asshole", "damn", "hell", "crap", "piss",
    "dick", "cock", "pussy", "bastard", "slut", "whore", "fag", "nigger",
    "retard", "cunt", "motherfucker", "hate", "kill", "die", "rape",
    // Common variations
    "fck", "sht", "btch", "a$$", "d4mn", "h3ll", "cr4p"
  ];

  // Sensitive word hints
  const sensitiveHints = {
    "die": "Life is precious, let's use more positive words",
    "hate": "Try using 'dislike' or 'disagree' instead",
    "kill": "Let's express ourselves more peacefully",
    "stupid": "Everyone is learning, try 'needs improvement'",
    "idiot": "Be kind, we all make mistakes"
  };

  // State management
  let state = {
    messages: [],
    filter: 'all',
    sort: 'newest',
    currentPage: 0,
    isLoading: false
  };

  // Initialize
  function init() {
    loadMessages();
    setupEventListeners();
    renderFeed();
    updateCharCounter();
  }

  // Setup event listeners
  function setupEventListeners() {
    const textarea = document.getElementById('message');
    textarea.addEventListener('input', updateCharCounter);
    textarea.addEventListener('keydown', handleKeyPress);
    
    document.getElementById('msgForm').addEventListener('submit', handleSubmit);
  }

  // Handle keyboard events
  function handleKeyPress(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      document.getElementById('msgForm').dispatchEvent(new Event('submit'));
    }
  }

  // Load messages
  function loadMessages() {
    try {
      const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
      state.messages = stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error('Failed to load messages:', e);
      state.messages = [];
    }
  }

  // Save messages
  function saveMessages() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.messages));
    } catch (e) {
      console.error('Failed to save messages:', e);
      showNotification('Storage full, some messages may not be saved', 'warning');
    }
  }

  // Get user likes
  function getLikes() {
    try {
      return JSON.parse(localStorage.getItem(CONFIG.LIKES_KEY) || '{}');
    } catch {
      return {};
    }
  }

  // Save likes
  function saveLikes(likes) {
    localStorage.setItem(CONFIG.LIKES_KEY, JSON.stringify(likes));
  }

  // Insert emoji
  function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    textarea.focus();
    
    updateCharCounter();
  }

  // Update character counter
  function updateCharCounter() {
    const textarea = document.getElementById('message');
    const counter = document.getElementById('charCounter');
    const count = document.getElementById('charCount');
    const length = textarea.value.length;
    
    count.textContent = length;
    
    if (length > 250) {
      counter.classList.add('warning');
    } else {
      counter.classList.remove('warning');
    }
  }

  // Content moderation
  function moderateContent(text) {
    const lowerText = text.toLowerCase();
    
    // Check for abusive words
    for (const word of abusiveWords) {
      if (lowerText.includes(word.toLowerCase())) {
        // Find sensitive word hints
        for (const [key, hint] of Object.entries(sensitiveHints)) {
          if (word.includes(key) || key.includes(word)) {
            return { 
              passed: false, 
              message: `Detected unfriendly language "${word}", ${hint}` 
            };
          }
        }
        return { 
          passed: false, 
          message: `Content contains unfriendly words "${word}", please revise` 
        };
      }
    }
    
    // Check for repeated characters
    if (/(.)\1{5,}/.test(text)) {
      return { 
        passed: false, 
        message: 'Please avoid excessive repeated characters' 
      };
    }
    
    // Check for all caps (shouting)
    if (text.length > 10 && text === text.toUpperCase() && /[A-Z]/.test(text)) {
      return { 
        passed: false, 
        message: 'Please avoid all caps, it seems like shouting' 
      };
    }
    
    return { passed: true };
  }

  // Handle form submission
  async function handleSubmit(e) {
    e.preventDefault();
    
    if (state.isLoading) return;
    
    const textarea = document.getElementById('message');
    const text = textarea.value.trim();
    
    if (!text) {
      showNotification('Please write something before sharing', 'warning');
      return;
    }
    
    // Content moderation
    const moderation = moderateContent(text);
    if (!moderation.passed) {
      showNotification(moderation.message, 'error');
      return;
    }
    
    // Prevent duplicate submission
    state.isLoading = true;
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    submitBtn.disabled = true;
    submitText.innerHTML = '<span class="loading"></span>';
    
    // Simulate submission delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Create new message
    const newMessage = {
      id: Date.now() + Math.random(),
      text: processText(text),
      time: Date.now(),
      likes: 0,
      mood: detectMood(text)
    };
    
    // Add to message list
    state.messages.unshift(newMessage);
    saveMessages();
    
    // Clear input
    textarea.value = '';
    updateCharCounter();
    
    // Restore button
    submitBtn.disabled = false;
    submitText.textContent = 'Share Mood';
    state.isLoading = false;
    
    // Show success notification
    showNotification('Your mood has been shared, thank you 🌈', 'success');
    
    // Re-render
    renderFeed();
    
    // Scroll to top to see new message
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Process text (auto-convert emojis)
  function processText(text) {
    // Auto-convert emoji codes
    const emojiMap = {
      ':)': '😊',
      ':-)': '😊',
      ':(': '😔',
      ':-(': '😔',
      ':D': '😄',
      ':-D': '😄',
      ':P': '😛',
      ':-P': '😛',
      ':o': '😮',
      ':-o': '😮',
      ':|': '😐',
      ':-|': '😐',
      ';)': '😉',
      ';-)': '😉',
      '<3': '❤️',
      '</3': '💔',
      ':*': '😘',
      ':heart:': '❤️',
      ':smile:': '😊',
      ':sad:': '😢',
      ':happy:': '😄',
      ':angry:': '😠',
      ':love:': '❤️',
      ':star:': '⭐',
      ':fire:': '🔥',
      ':thumbsup:': '👍',
      ':thumbsdown:': '👎',
      ':clap:': '👏',
      ':pray:': '🙏'
    };
    
    let processed = text;
    for (const [code, emoji] of Object.entries(emojiMap)) {
      processed = processed.replace(new RegExp(escapeRegExp(code), 'g'), emoji);
    }
    
    return processed;
  }

  // Escape regex special characters
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // Detect mood
  function detectMood(text) {
    const moods = {
      happy: ['happy', 'joy', 'glad', 'excited', 'great', 'awesome', 'wonderful', '😊', '😄', '🎉'],
      sad: ['sad', 'unhappy', 'down', 'depressed', 'lonely', 'cry', '😢', '😔', '💔'],
      angry: ['angry', 'mad', 'furious', 'annoyed', 'frustrated', '😠', '😡'],
      love: ['love', 'like', 'adore', 'heart', '❤️', '💕', '😍'],
      neutral: []
    };
    
    const lowerText = text.toLowerCase();
    for (const [mood, keywords] of Object.entries(moods)) {
      if (keywords.some(keyword => lowerText.includes(keyword) || text.includes(keyword))) {
        return mood;
      }
    }
    
    return 'neutral';
  }

  // Show notification
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    
    // Show notification
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // Auto hide
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  // Format time
  function formatTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    // Just now (within 1 minute)
    if (diff < 60000) {
      return 'just now';
    }
    
    // Minutes ago
    if (diff < 3600000) {
      const minutes = Math.floor(diff / 60000);
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    }
    
    // Hours ago
    if (diff < 86400000) {
      const hours = Math.floor(diff / 3600000);
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    }
    
    // Days ago
    if (diff < 604800000) {
      const days = Math.floor(diff / 86400000);
      return `${days} day${days > 1 ? 's' : ''} ago`;
    }
    
    // Specific date
    const date = new Date(timestamp);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Set filter
  function setFilter(filter) {
    state.filter = filter;
    state.currentPage = 0;
    
    // Update button states
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed', 'false');
    });
    event.target.classList.add('active');
    event.target.setAttribute('aria-pressed', 'true');
    
    renderFeed();
  }

  // Sort messages
  function sortMessages() {
    const sortSelect = document.getElementById('sortSelect');
    state.sort = sortSelect.value;
    state.currentPage = 0;
    renderFeed();
  }

  // Filter messages
  function filterMessages(messages) {
    const now = Date.now();
    const DAY = 86400000;
    
    switch (state.filter) {
      case 'today':
        return messages.filter(msg => now - msg.time < DAY);
      case 'week':
        return messages.filter(msg => now - msg.time < DAY * 7);
      default:
        return messages;
    }
  }

  // Sort messages list
  function sortMessagesList(messages) {
    const sorted = [...messages];
    
    switch (state.sort) {
      case 'oldest':
        return sorted.sort((a, b) => a.time - b.time);
      case 'popular':
        return sorted.sort((a, b) => b.likes - a.likes);
      default: // newest
        return sorted.sort((a, b) => b.time - a.time); }
  }

  // Toggle like
  function toggleLike(messageId) {
    const likes = getLikes();
    const message = state.messages.find(m => m.id === messageId);
    
    if (!message) return;
    
    if (likes[messageId]) {
      // Unlike
      delete likes[messageId];
      message.likes = Math.max(0, message.likes - 1);
    } else {
      // Like
      likes[messageId] = true;
      message.likes = (message.likes || 0) + 1;
    }
    
    saveLikes(likes);
    saveMessages();
    
    // Update UI
    const btn = document.querySelector(`[data-message-id="${messageId}"] .like-btn`);
    if (btn) {
      btn.classList.toggle('liked');
      const count = btn.querySelector('.like-count');
      if (count) {
        count.textContent = message.likes || 0;
      }
    }
  }

  // Report message
  function reportMessage(messageId) {
    if (!confirm('Are you sure you want to report this message?')) {
      return;
    }
    
    const reports = JSON.parse(localStorage.getItem(CONFIG.REPORT_KEY) || '{}');
    
    if (reports[messageId]) {
      showNotification('You have already reported this message', 'warning');
      return;
    }
    
    reports[messageId] = {
      time: Date.now(),
      count: (reports[messageId]?.count || 0) + 1
    };
    
    localStorage.setItem(CONFIG.REPORT_KEY, JSON.stringify(reports));
    
    // Hide message if reported too many times
    if (reports[messageId].count >= 3) {
      const index = state.messages.findIndex(m => m.id === messageId);
      if (index !== -1) {
        state.messages.splice(index, 1);
        saveMessages();
        renderFeed();
      }
    }
    
    showNotification('Report successful, thank you for maintaining community standards', 'success');
  }

  // Render feed
  function renderFeed() {
    const feed = document.getElementById('feed');
    const loadMoreDiv = document.getElementById('loadMore');
    
    // Filter and sort messages
    let filtered = filterMessages(state.messages);
    let sorted = sortMessagesList(filtered);
    
    // Pagination
    const start = state.currentPage * CONFIG.MESSAGES_PER_PAGE;
    const end = start + CONFIG.MESSAGES_PER_PAGE;
    const paginated = sorted.slice(0, end);
    
    if (paginated.length === 0) {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">💭</div>
          <p>No messages yet, be the first to share!</p>
        </div>
      `;
      loadMoreDiv.style.display = 'none';
      return;
    }
    
    // Get likes
    const likes = getLikes();
    
    // Render messages
    feed.innerHTML = paginated.map(msg => {
      const isLiked = likes[msg.id];
      const moodEmoji = getMoodEmoji(msg.mood);
      
      return `
        <article class="message" data-message-id="${msg.id}">
          <div class="message-content">
            ${escapeHtml(msg.text).replace(/\n/g, '<br>')}
          </div>
          <div class="message-footer">
            <time class="timestamp" datetime="${new Date(msg.time).toISOString()}">
              ${moodEmoji} ${formatTime(msg.time)}
            </time>
            <div class="message-actions">
              <button 
                class="action-btn like-btn ${isLiked ? 'liked' : ''}" 
                onclick="toggleLike(${msg.id})"
                aria-label="Like"
              >
                <span>${isLiked ? '❤️' : '🤍'}</span>
                <span class="like-count">${msg.likes || 0}</span>
              </button>
              <button 
                class="action-btn" 
                onclick="reportMessage(${msg.id})"
                aria-label="Report"
              >
                🚩 Report
              </button>
            </div>
          </div>
        </article>
      `;
    }).join('');
    
    // Show/hide load more button
    if (sorted.length > end) {
      loadMoreDiv.style.display = 'block';
    } else {
      loadMoreDiv.style.display = 'none';
    }
  }

  // Get mood emoji
  function getMoodEmoji(mood) {
    const moodEmojis = {
      happy: '😊',
      sad: '😔',
      angry: '😠',
      love: '❤️',
      neutral: '💭'
    };
    return moodEmojis[mood] || '💭';
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load more messages
  function loadMoreMessages() {
    state.currentPage++;
    renderFeed();
  }

  // Initialize app
  document.addEventListener('DOMContentLoaded', init);

  // Listen for storage changes (multi-tab sync)
  window.addEventListener('storage', (e) => {
    if (e.key === CONFIG.STORAGE_KEY) {
      loadMessages();
      renderFeed();
    }
  });

  // Refresh on visibility change
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      loadMessages();
      renderFeed();
    }
  });
</script>
</body>
</html>
