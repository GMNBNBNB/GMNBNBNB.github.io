<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anonymous Calming Forum - å¿ƒæƒ…é©¿ç«™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* å…¨å±€æ ·å¼ */
    * {
      box-sizing: border-box;
    }

    /* å¹³æ»‘æ»šåŠ¨ */
    html {
      scroll-behavior: smooth;
    }

    /* ä¸»é¢˜è‰²å½©å˜é‡ */
    :root {
      --primary-color: #5AC7A7;
      --secondary-color: #346187;
      --bg-gradient-start: #D9EFFF;
      --bg-gradient-end: #E5FFE5;
      --text-color: #335;
      --light-bg: rgba(255,255,255,0.85);
      --shadow-color: rgba(80,140,200,0.12);
      --border-color: #aad1f5;
      --success-color: #75cc93;
      --warning-color: #ff9966;
      --error-color: #ff6b6b;
    }

    /* æ·±è‰²æ¨¡å¼ */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-gradient-start: #1a2f4b;
        --bg-gradient-end: #2d4a5d;
        --text-color: #e0e0e0;
        --light-bg: rgba(30,30,30,0.85);
        --shadow-color: rgba(0,0,0,0.3);
        --border-color: #4a7c9e;
      }
    }

    body {
      margin: 0; 
      padding: 0;
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height: 100vh;
      color: var(--text-color);
      position: relative;
      overflow-x: hidden;
    }

    /* åŠ¨æ€èƒŒæ™¯è£…é¥° */
    .bg-decoration {
      position: fixed;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: float 20s infinite ease-in-out;
    }

    .bg-decoration:nth-child(1) {
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .bg-decoration:nth-child(2) {
      top: 70%;
      right: 10%;
      animation-delay: 5s;
      width: 150px;
      height: 150px;
    }

    .bg-decoration:nth-child(3) {
      bottom: 10%;
      left: 50%;
      animation-delay: 10s;
      width: 80px;
      height: 80px;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -30px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
    }

    .container {
      max-width: 600px;
      margin: 40px auto 24px auto;
      background: var(--light-bg);
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-color);
      padding: 36px 24px 28px 24px;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 1;
    }

    h1 {
      text-align: center;
      font-weight: 500;
      margin-bottom: 24px;
      color: var(--secondary-color);
      letter-spacing: 1px;
      font-size: 1.8em;
      position: relative;
    }

    h1::after {
      content: 'ğŸŒˆ';
      position: absolute;
      right: -40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8em;
      animation: rainbow 3s ease-in-out infinite;
    }

    @keyframes rainbow {
      0%, 100% { transform: translateY(-50%) rotate(0deg); }
      50% { transform: translateY(-50%) rotate(10deg); }
    }

    /* è¡¨å•åŒºåŸŸ */
    .form-section {
      margin-bottom: 24px;
      text-align: center;
    }

    /* å­—æ•°ç»Ÿè®¡ */
    .char-counter {
      text-align: right;
      font-size: 0.85em;
      color: #88a;
      margin-bottom: 8px;
      transition: color 0.3s;
    }

    .char-counter.warning {
      color: var(--warning-color);
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border: 2px solid transparent;
      border-radius: 12px;
      background: #F1F8FC;
      font-size: 1.05em;
      padding: 12px;
      resize: vertical;
      transition: all 0.3s;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.2);
    }

    /* æŒ‰é’®æ ·å¼ */
    button {
      padding: 10px 24px;
      background: var(--primary-color);
      border-radius: 10px;
      border: none;
      color: white;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    button:hover {
      background: #4db897;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(90, 199, 167, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* æŒ‰é’®æ³¢çº¹æ•ˆæœ */
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:active::after {
      width: 300px;
      height: 300px;
    }

    /* å·¥å…·æ  */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Emoji é€‰æ‹©å™¨ */
    .emoji-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      background: none;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.2s;
    }

    .emoji-btn:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }

    /* æç¤ºä¿¡æ¯ */
    .emoji-hint {
      color: #6BB5A9;
      font-size: 0.88em;
      text-align: center;
      margin-bottom: 8px;
    }

    /* ç¡®è®¤æ¶ˆæ¯ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success-color);
    }

    .notification.error {
      background: var(--error-color);
    }

    .notification.warning {
      background: var(--warning-color);
    }

    /* æ¶ˆæ¯æµ */
    .feed {
      margin-top: 32px;
      min-height: 100px;
    }

    /* ç­›é€‰å’Œæ’åº */
    .feed-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .filter-btn:hover {
      background: #e0e0e0;
    }

    .filter-btn.active:hover {
      background: #4db897;
    }

    /* æ¶ˆæ¯å¡ç‰‡ */
    .message {
      background: #fafbfc;
      border-radius: 12px;
      margin-bottom: 16px;
      padding: 16px 20px;
      box-shadow: 0 3px 12px var(--shadow-color);
      animation: slideIn 0.5s ease-out;
      position: relative;
      border-left: 4px solid var(--border-color);
      transition: all 0.3s;
    }

    .message:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-color);
    }

    @keyframes slideIn {
      from { 
        opacity: 0; 
        transform: translateX(-20px);
      }
      to { 
        opacity: 1; 
        transform: translateX(0);
      }
    }

    /* æ¶ˆæ¯å†…å®¹ */
    .message-content {
      font-size: 1.05em;
      line-height: 1.6;
      word-wrap: break-word;
      margin-bottom: 12px;
    }

    /* æ¶ˆæ¯åº•éƒ¨ä¿¡æ¯ */
    .message-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .timestamp {
      font-size: 0.85em;
      color: #88a;
    }

    /* äº’åŠ¨æŒ‰é’® */
    .message-actions {
      display: flex;
      gap: 12px;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9em;
      color: #88a;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .action-btn:hover {
      background: #f0f0f0;
      color: var(--primary-color);
    }

    .action-btn.liked {
      color: #ff6b6b;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #88a;
    }

    .empty-state-icon {
      font-size: 3em;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* åŠ è½½æ›´å¤šæŒ‰é’® */
    .load-more {
      text-align: center;
      margin-top: 24px;
    }

    .load-more-btn {
      background: none;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 8px 24px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .load-more-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 600px) {
      .container { 
        margin: 20px 10px;
        padding: 24px 16px;
      }
      
      h1 { 
        font-size: 1.5em;
      }
      
      h1::after {
        display: none;
      }
      
      textarea { 
        font-size: 1em; 
      }
      
      .notification {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
      }
      
      .notification.show {
        transform: translateY(0);
      }
      
      .feed-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-buttons {
        justify-content: center;
      }
    }

    /* æ— éšœç¢ä¼˜åŒ– */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ç„¦ç‚¹æ ·å¼ */
    *:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯è£…é¥° -->
  <div class="bg-decoration"></div>
  <div class="bg-decoration"></div>
  <div class="bg-decoration"></div> <div class="container" role="main" aria-label="åŒ¿åå¿ƒæƒ…ç•™è¨€å¢™">
    <h1>å¿ƒæƒ…é©¿ç«™</h1>
    
    <div class="form-section">
      <form id="msgForm" autocomplete="off">
        <div class="emoji-hint">åˆ†äº«ä½ æ­¤åˆ»çš„å¿ƒæƒ…ï¼Œè®©æ¸©æš–ä¼ é€’ âœ¨</div>
        
        <div class="toolbar">
          <div class="emoji-picker" role="toolbar" aria-label="è¡¨æƒ…é€‰æ‹©">
            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ˜Š')" aria-label="å¼€å¿ƒ">ğŸ˜Š</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ˜”')" aria-label="éš¾è¿‡">ğŸ˜”</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('â¤ï¸')" aria-label="çˆ±å¿ƒ">â¤ï¸</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸŒ±')" aria-label="æˆé•¿">ğŸŒ±</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸŒˆ')" aria-label="å½©è™¹">ğŸŒˆ</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ’ª')" aria-label="åŠ æ²¹">ğŸ’ª</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ¤—')" aria-label="æ‹¥æŠ±">ğŸ¤—</button>
            <button type="button" class="emoji-btn" onclick="insertEmoji('âœ¨')" aria-label="é—ªè€€">âœ¨</button>
          </div>
        </div>
        
        <div class="char-counter" id="charCounter" aria-live="polite">
          <span id="charCount">0</span> / 280
        </div>
        
        <textarea 
          id="message" 
          placeholder="å†™ä¸‹ä½ çš„å¿ƒæƒ…æˆ–æƒ³æ³•ï¼Œè¿™é‡Œæ˜¯ä½ çš„æ ‘æ´..." 
          maxlength="280" 
          aria-label="ç•™è¨€å†…å®¹"
          aria-describedby="charCounter"
          required
        ></textarea>
        
        <button type="submit" id="submitBtn">
          <span id="submitText">åˆ†äº«å¿ƒæƒ…</span>
        </button>
      </form>
    </div>

    <div class="feed-controls">
      <div class="filter-buttons" role="group" aria-label="ç­›é€‰é€‰é¡¹">
        <button class="filter-btn active" onclick="setFilter('all')" aria-pressed="true">å…¨éƒ¨</button>
        <button class="filter-btn" onclick="setFilter('today')" aria-pressed="false">ä»Šæ—¥</button>
        <button class="filter-btn" onclick="setFilter('week')" aria-pressed="false">æœ¬å‘¨</button>
      </div>
      <select id="sortSelect" aria-label="æ’åºæ–¹å¼" onchange="sortMessages()">
        <option value="newest">æœ€æ–°ä¼˜å…ˆ</option>
        <option value="oldest">æœ€æ—©ä¼˜å…ˆ</option>
        <option value="popular">æœ€å—æ¬¢è¿</option>
      </select>
    </div>

    <div class="feed" id="feed" role="feed" aria-live="polite" aria-label="ç•™è¨€åˆ—è¡¨">
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ’­</div>
        <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæ¥åšç¬¬ä¸€ä¸ªåˆ†äº«è€…å§ï¼</p>
      </div>
    </div>
    
    <div class="load-more" id="loadMore" style="display: none;">
      <button class="load-more-btn" onclick="loadMoreMessages()">åŠ è½½æ›´å¤š</button>
    </div>
  </div>

  <!-- é€šçŸ¥å®¹å™¨ -->
  <div id="notification" class="notification" role="alert" aria-live="assertive"></div>
  
<script>
  // é…ç½®
  const CONFIG = {
    MAX_MESSAGE_LENGTH: 280,
    MESSAGES_PER_PAGE: 10,
    STORAGE_KEY: 'forum_messages_v2',
    LIKES_KEY: 'forum_likes',
    REPORT_KEY: 'forum_reports'
  };

  // è¿ç¦è¯åˆ—è¡¨ï¼ˆæ‰©å±•ç‰ˆï¼‰
  const abusiveWords = [
    // è‹±æ–‡
    "fuck", "shit", "bitch", "asshole", "damn", "hell", "crap", "piss",
    "dick", "cock", "pussy", "bastard", "slut", "whore", "fag", "nigger",
    "retard", "cunt", "motherfucker", "hate", "kill", "die", "rape",
    // ä¸­æ–‡
    "å‚»é€¼", "æ“", "è‰", "å¦ˆçš„", "ä»–å¦ˆ", "ç‹—æ—¥", "ç‹å…«", "æ··è›‹", "ç•œç”Ÿ",
    "åƒåœ¾", "åºŸç‰©", "è ¢è´§", "ç™½ç—´", "å¼±æ™º", "è„‘æ®‹", "å»æ­»", "æ€", "æ»š",
    "æ¶å¿ƒ", "è´±", "å©Šå­", "é¸¡å·´", "å±Œ", "é€¼", "è‚", "è‰¹", "å¹²ä½ ", "æ—¥ä½ "
  ];

  // æ•æ„Ÿè¯æç¤º
  const sensitiveHints = {
    "æ­»": "ç”Ÿå‘½å¾ˆçè´µï¼Œè®©æˆ‘ä»¬ç”¨æ›´ç§¯æçš„è¯æ±‡å§",
    "hate": "è¯•è¯•ç”¨'ä¸å–œæ¬¢'æˆ–'ä¸å¤ªè®¤åŒ'æ¥è¡¨è¾¾",
    "åƒåœ¾": "æ¯ä¸ªäººéƒ½å€¼å¾—è¢«å°Šé‡ï¼Œæ¢ä¸ªæ¸©å’Œçš„è¯´æ³•å¦‚ä½•ï¼Ÿ",
    "è ¢": "æˆ‘ä»¬éƒ½åœ¨å­¦ä¹ æˆé•¿ï¼Œç”¨'éœ€è¦æ”¹è¿›'ä¼šæ›´å¥½",
    "æ»š": "è¡¨è¾¾ä¸æ»¡å¯ä»¥ç”¨'è¯·ç¦»å¼€'æˆ–'ä¸å¤ªåˆé€‚'"
  };

  // çŠ¶æ€ç®¡ç†
  let state = {
    messages: [],
    filter: 'all',
    sort: 'newest',
    currentPage: 0,
    isLoading: false
  };

  // åˆå§‹åŒ–
  function init() {
    loadMessages();
    setupEventListeners();
    renderFeed();
    updateCharCounter();
  }

  // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
  function setupEventListeners() {
    const textarea = document.getElementById('message');
    textarea.addEventListener('input', updateCharCounter);
    textarea.addEventListener('keydown', handleKeyPress);
    
    document.getElementById('msgForm').addEventListener('submit', handleSubmit);
  }

  // å¤„ç†é”®ç›˜äº‹ä»¶
  function handleKeyPress(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
      e.preventDefault();
      document.getElementById('msgForm').dispatchEvent(new Event('submit'));
    }
  }

  // åŠ è½½æ¶ˆæ¯
  function loadMessages() {
    try {
      const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
      state.messages = stored ? JSON.parse(stored) : [];
    } catch (e) {
      console.error('Failed to load messages:', e);
      state.messages = [];
    }
  }

  // ä¿å­˜æ¶ˆæ¯
  function saveMessages() {
    try {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.messages));
    } catch (e) {
      console.error('Failed to save messages:', e);
      showNotification('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œéƒ¨åˆ†æ¶ˆæ¯å¯èƒ½æ— æ³•ä¿å­˜', 'warning');
    }
  }

  // è·å–ç”¨æˆ·ç‚¹èµè®°å½•
  function getLikes() {
    try {
      return JSON.parse(localStorage.getItem(CONFIG.LIKES_KEY) || '{}');
    } catch {
      return {};
    }
  }

  // ä¿å­˜ç‚¹èµè®°å½•
  function saveLikes(likes) {
    localStorage.setItem(CONFIG.LIKES_KEY, JSON.stringify(likes));
  }

  // æ’å…¥è¡¨æƒ…
  function insertEmoji(emoji) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    textarea.focus();
    
    updateCharCounter();
  }

  // æ›´æ–°å­—ç¬¦è®¡æ•°
  function updateCharCounter() {
    const textarea = document.getElementById('message');
    const counter = document.getElementById('charCounter');
    const count = document.getElementById('charCount');
    const length = textarea.value.length;
    
    count.textContent = length;
    
    if (length > 250) {
      counter.classList.add('warning');
    } else {
      counter.classList.remove('warning');
    }
  }

  // å†…å®¹å®¡æ ¸
  function moderateContent(text) {
    const lowerText = text.toLowerCase();
    
    // æ£€æŸ¥è¿ç¦è¯
    for (const word of abusiveWords) {
      if (lowerText.includes(word.toLowerCase())) {
        // æŸ¥æ‰¾æ•æ„Ÿè¯æç¤º
        for (const [key, hint] of Object.entries(sensitiveHints)) {
          if (word.includes(key) || key.includes(word)) {
            return { 
              passed: false, 
              message: `æ£€æµ‹åˆ°ä¸å‹å–„ç”¨è¯­"${word}"ï¼Œ${hint}` 
            };
          }
        }
        return { 
          passed: false, 
          message: `å†…å®¹åŒ…å«ä¸å‹å–„è¯è¯­"${word}"ï¼Œè¯·ä¿®æ”¹åå†å‘é€` 
        };
      }
    }
    
    // æ£€æŸ¥é‡å¤å­—ç¬¦ï¼ˆå¦‚"å•Šå•Šå•Šå•Šå•Šå•Š"ï¼‰
    if (/(.)\1{5,}/.test(text)) {
      return { 
        passed: false, 
        message: 'è¯·é¿å…è¿‡å¤šé‡å¤å­—ç¬¦ï¼Œè®©è¡¨è¾¾æ›´æ¸…æ™°' 
      };
    }
    
    // æ£€æŸ¥å…¨å¤§å†™ï¼ˆå¯èƒ½æ˜¯å–Šå«ï¼‰
    if (text.length > 10 && text === text.toUpperCase() && /[A-Z]/.test(text)) {
      return { 
        passed: false, 
        message: 'è¯·é¿å…å…¨éƒ¨å¤§å†™ï¼Œè¿™æ ·æ˜¾å¾—åœ¨å¤§å£°å–Šå«å“¦' 
      };
    }
    
    return { passed: true };
  }

  // å¤„ç†è¡¨å•æäº¤
  async function handleSubmit(e) {
    e.preventDefault();
    
    if (state.isLoading) return;
    
    const textarea = document.getElementById('message');
    const text = textarea.value.trim();
    
    if (!text) {
      showNotification('è¯·å†™ä¸‹ä½ çš„å¿ƒæƒ…å†åˆ†äº«å“¦ï½', 'warning');
      return;
    }
    
    // å†…å®¹å®¡æ ¸
    const moderation = moderateContent(text);
    if (!moderation.passed) {
      showNotification(moderation.message, 'error');
      return;
    }
    
    // é˜²æ­¢é‡å¤æäº¤
    state.isLoading = true;
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    submitBtn.disabled = true;
    submitText.innerHTML = '<span class="loading"></span>';
    
    // æ¨¡æ‹Ÿæäº¤å»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // åˆ›å»ºæ–°æ¶ˆæ¯
    const newMessage = {
      id: Date.now() + Math.random(),
      text: processText(text),
      time: Date.now(),
      likes: 0,
      mood: detectMood(text)
    };
    
    // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    state.messages.unshift(newMessage);
    saveMessages();
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    textarea.value = '';
    updateCharCounter();
    
    // æ¢å¤æŒ‰é’®
    submitBtn.disabled = false;
    submitText.textContent = 'åˆ†äº«å¿ƒæƒ…';
    state.isLoading = false;
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    showNotification('å¿ƒæƒ…å·²åˆ†äº«ï¼Œæ„Ÿè°¢ä½ çš„çœŸè¯šè¡¨è¾¾ ğŸŒˆ', 'success');
    
    // é‡æ–°æ¸²æŸ“
    renderFeed();
    
    // æ»šåŠ¨åˆ°é¡¶éƒ¨æŸ¥çœ‹æ–°æ¶ˆæ¯
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // å¤„ç†æ–‡æœ¬ï¼ˆè‡ªåŠ¨è½¬æ¢è¡¨æƒ…ç­‰ï¼‰
  function processText(text) {
    // è‡ªåŠ¨è½¬æ¢è¡¨æƒ…ä»£ç 
    const emojiMap = {
      ':)': 'ğŸ˜Š',
      ':-)': 'ğŸ˜Š',
      ':(': 'ğŸ˜”',
      ':-(': 'ğŸ˜”',
      ':D': 'ğŸ˜„',
      ':-D': 'ğŸ˜„',
      ':P': 'ğŸ˜›',
      ':-P': 'ğŸ˜›',
      ':o': 'ğŸ˜®',
      ':-o': 'ğŸ˜®',
      ':|': 'ğŸ˜',
      ':-|': 'ğŸ˜',
      ';)': 'ğŸ˜‰',
      ';-)': 'ğŸ˜‰',
      '<3': 'â¤ï¸',
      '</3': 'ğŸ’”',
      ':*': 'ğŸ˜˜',
      ':heart:': 'â¤ï¸',
      ':smile:': 'ğŸ˜Š',
      ':sad:': 'ğŸ˜¢',
      ':happy:': 'ğŸ˜„',
      ':angry:': 'ğŸ˜ ',
      ':love:': 'â¤ï¸',
      ':star:': 'â­',
      ':fire:': 'ğŸ”¥',
      ':thumbsup:': 'ğŸ‘',
      ':thumbsdown:': 'ğŸ‘',
      ':clap:': 'ğŸ‘',
      ':pray:': 'ğŸ™'
    };
    
    let processed = text;
    for (const [code, emoji] of Object.entries(emojiMap)) {
      processed = processed.replace(new RegExp(escapeRegExp(code), 'g'), emoji);
    }
    
    return processed;
  }

  // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // æ£€æµ‹å¿ƒæƒ…
  function detectMood(text) {
    const moods = {
      happy: ['å¼€å¿ƒ', 'å¿«ä¹', 'é«˜å…´', 'ğŸ˜Š', 'ğŸ˜„', 'ğŸ‰', 'happy', 'joy', 'glad'],
      sad: ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'éš¾å—', 'ğŸ˜¢', 'ğŸ˜”', 'ğŸ’”', 'sad', 'unhappy', 'down'],
      angry: ['ç”Ÿæ°”', 'æ„¤æ€’', 'æ°”æ­»', 'ğŸ˜ ', 'ğŸ˜¡', 'angry', 'mad', 'furious'],
      love: ['çˆ±', 'å–œæ¬¢', 'â¤ï¸', 'ğŸ’•', 'ğŸ˜', 'love', 'like'],
      neutral: []
    };
    
    for (const [mood, keywords] of Object.entries(moods)) {
      if (keywords.some(keyword => text.includes(keyword))) {
        return mood;
      }
    }
    
    return 'neutral';
  }

  // æ˜¾ç¤ºé€šçŸ¥
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    
    // æ˜¾ç¤ºé€šçŸ¥
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  // æ ¼å¼åŒ–æ—¶é—´
  function formatTime (timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    // åˆšåˆšï¼ˆ1åˆ†é’Ÿå†…ï¼‰
    if (diff < 60000) {
      return 'åˆšåˆš';
    }
    
    // å‡ åˆ†é’Ÿå‰
    if (diff < 3600000) {
      const minutes = Math.floor(diff / 60000);
      return `${minutes}åˆ†é’Ÿå‰`;
    }
    
    // å‡ å°æ—¶å‰
    if (diff < 86400000) {
      const hours = Math.floor(diff / 3600000);
      return `${hours}å°æ—¶å‰`;
    }
    
    // å‡ å¤©å‰
    if (diff < 604800000) {
      const days = Math.floor(diff / 86400000);
      return `${days}å¤©å‰`;
    }
    
    // å…·ä½“æ—¥æœŸ
    const date = new Date(timestamp);
    return date.toLocaleDateString('zh-CN', {
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // è®¾ç½®ç­›é€‰å™¨
  function setFilter(filter) {
    state.filter = filter;
    state.currentPage = 0;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed', 'false');
    });
    event.target.classList.add('active');
    event.target.setAttribute('aria-pressed', 'true');
    
    renderFeed();
  }

  // æ’åºæ¶ˆæ¯
  function sortMessages() {
    const sortSelect = document.getElementById('sortSelect');
    state.sort = sortSelect.value;
    state.currentPage = 0;
    renderFeed();
  }

  // è¿‡æ»¤æ¶ˆæ¯
  function filterMessages(messages) {
    const now = Date.now();
    const DAY = 86400000;
    
    switch (state.filter) {
      case 'today':
        return messages.filter(msg => now - msg.time < DAY);
      case 'week':
        return messages.filter(msg => now - msg.time < DAY * 7);
      default:
        return messages;
    }
  }

  // æ’åºæ¶ˆæ¯
  function sortMessagesList(messages) {
    const sorted = [...messages];
    
    switch (state.sort) {
      case 'oldest':
        return sorted.sort((a, b) => a.time - b.time);
      case 'popular':
        return sorted.sort((a, b) => b.likes - a.likes);
      default: // newest
        return sorted.sort((a, b) => b.time - a.time);
    }
  }

  // ç‚¹èµåŠŸèƒ½
  function toggleLike(messageId) {
    const likes = getLikes();
    const message = state.messages.find(m => m.id === messageId);
    
    if (!message) return;
    
    if (likes[messageId]) {
      // å–æ¶ˆç‚¹èµ
      delete likes[messageId];
      message.likes = Math.max(0, message.likes - 1);
    } else {
      // ç‚¹èµ
      likes[messageId] = true;
      message.likes = (message.likes || 0) + 1;
    }
    
    saveLikes(likes);
    saveMessages();
    
    // æ›´æ–°UI
    const btn = document.querySelector(`[data-message-id="${messageId}"] .like-btn`);
    if (btn) {
      btn.classList.toggle('liked');
      const count = btn.querySelector('.like-count');
      if (count) {
        count.textContent = message.likes || 0;
      }
    }
  }

  // ä¸¾æŠ¥åŠŸèƒ½
  function reportMessage(messageId) {
    if (!confirm('ç¡®å®šè¦ä¸¾æŠ¥è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
      return;
    }
    
    const reports = JSON.parse(localStorage.getItem(CONFIG.REPORT_KEY) || '{}');
    
    if (reports[messageId]) {
      showNotification('ä½ å·²ç»ä¸¾æŠ¥è¿‡è¿™æ¡ç•™è¨€äº†', 'warning');
      return;
    }
    
    reports[messageId] = {
      time: Date.now(),
      count: (reports[messageId]?.count || 0) + 1
    };
    
    localStorage.setItem(CONFIG.REPORT_KEY, JSON.stringify(reports));
    
    // å¦‚æœä¸¾æŠ¥æ¬¡æ•°è¿‡å¤šï¼Œéšè—æ¶ˆæ¯
    if (reports[messageId].count >= 3) {
      const index = state.messages.findIndex(m => m.id === messageId);
      if (index !== -1) {
        state.messages.splice(index, 1);
        saveMessages();
        renderFeed();
      }
    }
    
    showNotification('ä¸¾æŠ¥æˆåŠŸï¼Œæ„Ÿè°¢ä½ ç»´æŠ¤ç¤¾åŒºç¯å¢ƒ', 'success');
  }

  // æ¸²æŸ“æ¶ˆæ¯æµ
  function renderFeed() {
    const feed = document.getElementById('feed');
    const loadMoreDiv = document.getElementById('loadMore');
    
    // è¿‡æ»¤å’Œæ’åºæ¶ˆæ¯
    let filtered = filterMessages(state.messages);
    let sorted = sortMessagesList(filtered);
    
    // åˆ†é¡µ
    const start = state.currentPage * CONFIG.MESSAGES_PER_PAGE;
    const end = start + CONFIG.MESSAGES_PER_PAGE;
    const paginated = sorted.slice(0, end);
    
    if (paginated.length === 0) {
      feed.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’­</div>
          <p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæ¥åšç¬¬ä¸€ä¸ªåˆ†äº«è€…å§ï¼</p>
        </div>
      `;
      loadMoreDiv.style.display = 'none';
      return;
    }
    
    // è·å–ç‚¹èµè®°å½•
    const likes = getLikes();
    
    // æ¸²æŸ“æ¶ˆæ¯
    feed.innerHTML = paginated.map(msg => {
      const isLiked = likes[msg.id];
      const moodEmoji = getMoodEmoji(msg.mood);
      
      return `
        <article class="message" data-message-id="${msg.id}">
          <div class="message-content">
            ${escapeHtml(msg.text).replace(/\n/g, '<br>')}
          </div>
          <div class="message-footer">
            <time class="timestamp" datetime="${new Date(msg.time).toISOString()}">
              ${moodEmoji} ${formatTime(msg.time)}
            </time>
            <div class="message-actions">
              <button 
                class="action-btn like-btn ${isLiked ? 'liked' : ''}" 
                onclick="toggleLike(${msg.id})"
                aria-label="ç‚¹èµ"
              >
                <span>${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                <span class="like-count">${msg.likes || 0}</span>
              </button>
              <button 
                class="action-btn" 
                onclick="reportMessage(${msg.id})"
                aria-label="ä¸¾æŠ¥"
              >
                ğŸš© ä¸¾æŠ¥
              </button>
            </div>
          </div>
        </article>
      `;
    }).join('');
    
    // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
    if (sorted.length > end) {
      loadMoreDiv.style.display = 'block';
    } else {
      loadMoreDiv.style.display = 'none';
    }
  }

  // è·å–å¿ƒæƒ…è¡¨æƒ…
  function getMoodEmoji(mood) {
    const moodEmojis = {
      happy: 'ğŸ˜Š',
      sad: 'ğŸ˜”',
      angry: 'ğŸ˜ ',
      love: 'â¤ï¸',
      neutral: 'ğŸ’­'
    };
    return moodEmojis[mood] || 'ğŸ’­';
  }

  // è½¬ä¹‰HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // åŠ è½½æ›´å¤šæ¶ˆæ¯
  function loadMoreMessages() {
    state.currentPage++;
    renderFeed();
  }

  // åˆå§‹åŒ–åº”ç”¨
  document.addEventListener('DOMContentLoaded', init);

  // ç›‘å¬å­˜å‚¨å˜åŒ–ï¼ˆå¤šæ ‡ç­¾é¡µåŒæ­¥ï¼‰
  window.addEventListener('storage', (e) => {
    if (e.key === CONFIG.STORAGE_KEY) {
      loadMessages();
      renderFeed();
    }
  });

  // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      loadMessages();
      renderFeed();
    }
  });
</script>
</body>
</html>
